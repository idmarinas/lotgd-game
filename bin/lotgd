#!/usr/bin/env php
<?php

use Doctrine\Common\Annotations\AnnotationRegistry;
use Lotgd\Core\Console\Application;
use Lotgd\Core\Kernel;
use Lotgd\Core\ServiceManager;
use Symfony\Component\Console\Input\ArgvInput;
use Symfony\Component\Dotenv\Dotenv;

if ( ! \in_array(PHP_SAPI, ['cli', 'phpdbg', 'embed'], true))
{
    echo 'Warning: The console should be invoked via the CLI version of PHP, not the '.PHP_SAPI.' SAPI'.PHP_EOL;
}

\set_time_limit(0);

//-- Autoload class
require \dirname(__DIR__).'/vendor/autoload.php';

//-- Include constants
require_once \dirname(__DIR__).'/lib/constants.php';

$isDev = \file_exists(\dirname(__DIR__).'/config/development.config.php');

$input = new ArgvInput();

if (null !== $env = $input->getParameterOption(['--env', '-e'], $isDev, true))
{
    \putenv('APP_ENV='.$_SERVER['APP_ENV'] = $_ENV['APP_ENV'] = $env);
}
//-- Autoload annotations
AnnotationRegistry::registerLoader(
    function ($className)
    {
        return \class_exists($className);
    }
);

(new Dotenv())->bootEnv(\dirname(__DIR__).'/.env');

$kernel = new Kernel($_SERVER['APP_ENV'], (bool) $_SERVER['APP_DEBUG']);
$sm     = new ServiceManager();

$application = new Application($sm, $kernel);
$application->run($input);
