#!/usr/bin/env php
<?php

use Doctrine\Common\Annotations\AnnotationRegistry;
use Lotgd\Core\Console\Application;
use Lotgd\Core\ServiceManager;
use Symfony\Component\Console\Input\ArgvInput;

if ( ! \in_array(PHP_SAPI, ['cli', 'phpdbg', 'embed'], true))
{
    echo 'Warning: The console should be invoked via the CLI version of PHP, not the '.PHP_SAPI.' SAPI'.PHP_EOL;
}

\set_time_limit(0);

//-- Autoload class
require \dirname(__DIR__).'/vendor/autoload.php';

//-- Include constants
require_once \dirname(__DIR__).'/lib/constants.php';

$isDev = \file_exists(\dirname(__DIR__).'/config/development.config.php');

$input = new ArgvInput();
$env   = $input->getParameterOption(['--env', '-e'], $isDev, true);

if (null !== $env)
{
    \putenv('APP_ENV='.$_SERVER['APP_ENV'] = $_ENV['APP_ENV'] = $env);
}
//-- Autoload annotations
AnnotationRegistry::registerLoader(
    function ($className)
    {
        return \class_exists($className);
    }
);

$serviceManager = new ServiceManager();

$application = new Application($serviceManager);
$application->run($input);
