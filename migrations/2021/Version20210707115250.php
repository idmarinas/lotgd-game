<?php

declare(strict_types=1);

namespace DoctrineMigrations;

use Doctrine\DBAL\Schema\Schema;
use Doctrine\Migrations\AbstractMigration;

/**
 * Auto-generated Migration: Please modify to your needs!
 */
final class Version20210707115250 extends AbstractMigration
{
    public function getDescription(): string
    {
        return '6.0.0';
    }

    public function up(Schema $schema): void
    {
        // this up() migration is auto-generated, please modify it to your needs
        $this->addSql('ALTER TABLE characters DROP FOREIGN KEY FK_3A29410E9D02C3AF');
        $this->addSql('ALTER TABLE accounts DROP FOREIGN KEY FK_CAC89EAC1136BE75');
        $this->addSql('CREATE TABLE avatar (id INT UNSIGNED AUTO_INCREMENT NOT NULL, acct_id INT UNSIGNED DEFAULT NULL, name VARCHAR(100) NOT NULL, playername VARCHAR(40) NOT NULL, sex SMALLINT DEFAULT 0 NOT NULL, strength INT UNSIGNED DEFAULT 10 NOT NULL, dexterity INT UNSIGNED DEFAULT 10 NOT NULL, intelligence INT UNSIGNED DEFAULT 10 NOT NULL, constitution INT UNSIGNED DEFAULT 10 NOT NULL, wisdom INT UNSIGNED DEFAULT 10 NOT NULL, specialty VARCHAR(20) NOT NULL, experience INT UNSIGNED DEFAULT 0 NOT NULL, gold INT UNSIGNED DEFAULT 0 NOT NULL, weapon VARCHAR(50) DEFAULT \'Fists\' NOT NULL, armor VARCHAR(50) DEFAULT \'T-Shirt\' NOT NULL, seenmaster TINYINT(1) DEFAULT \'0\' NOT NULL, level SMALLINT UNSIGNED DEFAULT 1 NOT NULL, defense INT UNSIGNED DEFAULT 0 NOT NULL, attack INT UNSIGNED DEFAULT 0 NOT NULL, alive TINYINT(1) DEFAULT \'1\' NOT NULL, goldinbank INT DEFAULT 0 NOT NULL, marriedto INT UNSIGNED DEFAULT 0 NOT NULL, spirits INT NOT NULL, hitpoints INT UNSIGNED DEFAULT 10 NOT NULL, maxhitpoints INT UNSIGNED DEFAULT 10 NOT NULL, permahitpoints INT DEFAULT 0 NOT NULL, gems INT DEFAULT 0 NOT NULL, weaponvalue INT DEFAULT 0 NOT NULL, armorvalue INT DEFAULT 0 NOT NULL, location VARCHAR(50) DEFAULT \'Degolburg\' NOT NULL, turns INT DEFAULT 10 NOT NULL, title VARCHAR(50) NOT NULL, badguy LONGTEXT NOT NULL COMMENT \'(DC2Type:array)\', companions LONGTEXT NOT NULL COMMENT \'(DC2Type:array)\', allowednavs LONGTEXT NOT NULL COMMENT \'(DC2Type:array)\', resurrections INT UNSIGNED DEFAULT 0 NOT NULL, weapondmg INT NOT NULL, armordef INT NOT NULL, age INT UNSIGNED DEFAULT 0 NOT NULL, charm INT DEFAULT 0 NOT NULL, specialinc VARCHAR(50) NOT NULL, specialmisc VARCHAR(1000) NOT NULL, lastmotd DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, playerfights INT DEFAULT 3 NOT NULL, lasthit DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, seendragon TINYINT(1) DEFAULT \'0\' NOT NULL, dragonkills INT UNSIGNED DEFAULT 0 NOT NULL, restorepage VARCHAR(150) NOT NULL, hashorse INT DEFAULT 0, bufflist LONGTEXT NOT NULL COMMENT \'(DC2Type:array)\', dragonpoints LONGTEXT NOT NULL COMMENT \'(DC2Type:array)\', boughtroomtoday TINYINT(1) DEFAULT \'0\' NOT NULL, sentnotice TINYINT(1) DEFAULT \'0\' NOT NULL, pvpflag DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, transferredtoday SMALLINT DEFAULT 0 NOT NULL, soulpoints INT UNSIGNED DEFAULT 0 NOT NULL, gravefights INT UNSIGNED DEFAULT 0 NOT NULL, hauntedby VARCHAR(50) NOT NULL, deathpower INT UNSIGNED DEFAULT 0 NOT NULL, recentcomments DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, bio VARCHAR(255) NOT NULL, race VARCHAR(50) DEFAULT \'0\' NOT NULL, biotime DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, amountouttoday INT UNSIGNED DEFAULT 0 NOT NULL, pk TINYINT(1) DEFAULT \'0\' NOT NULL, dragonage INT UNSIGNED DEFAULT 0 NOT NULL, bestdragonage INT UNSIGNED DEFAULT 0 NOT NULL, ctitle VARCHAR(25) NOT NULL, slaydragon TINYINT(1) DEFAULT \'0\' NOT NULL, fedmount TINYINT(1) DEFAULT \'0\' NOT NULL, clanid INT UNSIGNED DEFAULT 0, clanrank SMALLINT UNSIGNED DEFAULT 0 NOT NULL, clanjoindate DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, chatloc VARCHAR(255) NOT NULL, UNIQUE INDEX UNIQ_1677722F6E6926DF (playername), UNIQUE INDEX UNIQ_1677722F9D02C3AF (acct_id), INDEX name (name), INDEX level (level), INDEX alive (alive), INDEX lasthit (lasthit), INDEX clanid (clanid), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE `utf8_unicode_ci` ENGINE = InnoDB');
        $this->addSql('CREATE TABLE user (acctid INT UNSIGNED AUTO_INCREMENT NOT NULL, avatar_id INT UNSIGNED DEFAULT NULL, laston DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, loggedin TINYINT(1) DEFAULT \'0\' NOT NULL, superuser INT UNSIGNED DEFAULT 0 NOT NULL, login VARCHAR(50) NOT NULL, lastmotd DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, locked TINYINT(1) DEFAULT \'0\' NOT NULL, lastip VARCHAR(40) NOT NULL, uniqueid VARCHAR(32) NOT NULL, boughtroomtoday TINYINT(1) DEFAULT \'0\' NOT NULL, emailaddress VARCHAR(128) NOT NULL, replaceemail VARCHAR(128) NOT NULL, emailvalidation VARCHAR(32) DEFAULT NULL, sentnotice TINYINT(1) DEFAULT \'0\' NOT NULL, prefs LONGTEXT NOT NULL COMMENT \'(DC2Type:array)\', transferredtoday SMALLINT UNSIGNED DEFAULT 0 NOT NULL, recentcomments DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, amountouttoday INT UNSIGNED DEFAULT 0 NOT NULL, regdate DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, banoverride TINYINT(1) DEFAULT \'0\', donation INT UNSIGNED NOT NULL, donationspent INT UNSIGNED NOT NULL, donationconfig LONGTEXT NOT NULL COMMENT \'(DC2Type:array)\', referer INT UNSIGNED DEFAULT 0 NOT NULL, refererawarded INT UNSIGNED DEFAULT 0 NOT NULL, password VARCHAR(255) NOT NULL, forgottenpassword VARCHAR(255) DEFAULT NULL, UNIQUE INDEX UNIQ_8D93D649AA08CB10 (login), UNIQUE INDEX UNIQ_8D93D64986383B10 (avatar_id), INDEX login (login), INDEX laston (laston), INDEX emailaddress (emailaddress), INDEX locked (locked, loggedin, laston), INDEX referer (referer), INDEX uniqueid (uniqueid), INDEX emailvalidation (emailvalidation), PRIMARY KEY(acctid)) DEFAULT CHARACTER SET utf8 COLLATE `utf8_unicode_ci` ENGINE = InnoDB');
        $this->addSql('ALTER TABLE user ADD roles LONGTEXT NOT NULL COMMENT \'(DC2Type:json)\'');

        //-- Import old data to new tables
        $this->importData();

        $this->addSql('ALTER TABLE avatar ADD CONSTRAINT FK_1677722F9D02C3AF FOREIGN KEY (acct_id) REFERENCES user (acctid) ON DELETE SET NULL');
        $this->addSql('ALTER TABLE user ADD CONSTRAINT FK_8D93D64986383B10 FOREIGN KEY (avatar_id) REFERENCES avatar (id)');
        $this->addSql('DROP TABLE accounts');
        $this->addSql('DROP TABLE characters');
        $this->addSql('DROP INDEX uri ON referers');
        $this->addSql('CREATE INDEX uri ON referers (uri)');
    }

    public function down(Schema $schema): void
    {
        // this down() migration is auto-generated, please modify it to your needs
        $this->addSql('ALTER TABLE user DROP FOREIGN KEY FK_8D93D64986383B10');
        $this->addSql('ALTER TABLE avatar DROP FOREIGN KEY FK_1677722F9D02C3AF');
        $this->addSql('CREATE TABLE accounts (acctid INT UNSIGNED AUTO_INCREMENT NOT NULL, character_id INT UNSIGNED DEFAULT NULL, laston DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, password VARCHAR(32) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, loggedin TINYINT(1) DEFAULT \'0\' NOT NULL, superuser INT UNSIGNED DEFAULT 0 NOT NULL, login VARCHAR(50) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, lastmotd DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, locked TINYINT(1) DEFAULT \'0\' NOT NULL, lastip VARCHAR(40) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, uniqueid VARCHAR(32) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, boughtroomtoday TINYINT(1) DEFAULT \'0\' NOT NULL, emailaddress VARCHAR(128) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, replaceemail VARCHAR(128) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, emailvalidation VARCHAR(32) CHARACTER SET utf8 DEFAULT NULL COLLATE `utf8_unicode_ci`, forgottenpassword VARCHAR(32) CHARACTER SET utf8 DEFAULT NULL COLLATE `utf8_unicode_ci`, sentnotice TINYINT(1) DEFAULT \'0\' NOT NULL, prefs LONGTEXT CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci` COMMENT \'(DC2Type:array)\', transferredtoday SMALLINT UNSIGNED DEFAULT 0 NOT NULL, recentcomments DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, donation INT UNSIGNED DEFAULT 0 NOT NULL, donationspent INT UNSIGNED DEFAULT 0 NOT NULL, donationconfig LONGTEXT CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci` COMMENT \'(DC2Type:array)\', referer INT UNSIGNED DEFAULT 0 NOT NULL, refererawarded INT UNSIGNED DEFAULT 0 NOT NULL, banoverride TINYINT(1) DEFAULT \'0\', translatorlanguages VARCHAR(128) CHARACTER SET utf8 DEFAULT \'en\' NOT NULL COLLATE `utf8_unicode_ci`, amountouttoday INT UNSIGNED DEFAULT 0 NOT NULL, beta TINYINT(1) DEFAULT \'0\' NOT NULL, regdate DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, INDEX referer (referer), INDEX emailvalidation (emailvalidation), UNIQUE INDEX UNIQ_CAC89EACAA08CB10 (login), INDEX login (login), INDEX emailaddress (emailaddress), INDEX uniqueid (uniqueid), UNIQUE INDEX UNIQ_CAC89EAC1136BE75 (character_id), INDEX laston (laston), INDEX locked (locked, loggedin, laston), PRIMARY KEY(acctid)) DEFAULT CHARACTER SET utf8 COLLATE `utf8_unicode_ci` ENGINE = InnoDB COMMENT = \'\' ');
        $this->addSql('CREATE TABLE characters (id INT UNSIGNED AUTO_INCREMENT NOT NULL, acct_id INT UNSIGNED DEFAULT NULL, name VARCHAR(100) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, playername VARCHAR(40) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, sex SMALLINT DEFAULT 0 NOT NULL, strength INT UNSIGNED DEFAULT 10 NOT NULL, dexterity INT UNSIGNED DEFAULT 10 NOT NULL, intelligence INT UNSIGNED DEFAULT 10 NOT NULL, constitution INT UNSIGNED DEFAULT 10 NOT NULL, wisdom INT UNSIGNED DEFAULT 10 NOT NULL, specialty VARCHAR(20) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, experience INT UNSIGNED DEFAULT 0 NOT NULL, gold INT UNSIGNED DEFAULT 0 NOT NULL, weapon VARCHAR(50) CHARACTER SET utf8 DEFAULT \'Fists\' NOT NULL COLLATE `utf8_unicode_ci`, armor VARCHAR(50) CHARACTER SET utf8 DEFAULT \'T-Shirt\' NOT NULL COLLATE `utf8_unicode_ci`, seenmaster TINYINT(1) DEFAULT \'0\' NOT NULL, level SMALLINT UNSIGNED DEFAULT 1 NOT NULL, defense INT UNSIGNED DEFAULT 0 NOT NULL, attack INT UNSIGNED DEFAULT 0 NOT NULL, alive TINYINT(1) DEFAULT \'1\' NOT NULL, goldinbank INT DEFAULT 0 NOT NULL, marriedto INT UNSIGNED DEFAULT 0 NOT NULL, spirits INT NOT NULL, hitpoints INT UNSIGNED DEFAULT 10 NOT NULL, maxhitpoints INT UNSIGNED DEFAULT 10 NOT NULL, permahitpoints INT DEFAULT 0 NOT NULL, gems INT DEFAULT 0 NOT NULL, weaponvalue INT DEFAULT 0 NOT NULL, armorvalue INT DEFAULT 0 NOT NULL, location VARCHAR(50) CHARACTER SET utf8 DEFAULT \'Degolburg\' NOT NULL COLLATE `utf8_unicode_ci`, turns INT DEFAULT 10 NOT NULL, title VARCHAR(50) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, badguy LONGTEXT CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci` COMMENT \'(DC2Type:array)\', companions LONGTEXT CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci` COMMENT \'(DC2Type:array)\', allowednavs LONGTEXT CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci` COMMENT \'(DC2Type:array)\', resurrections INT UNSIGNED DEFAULT 0 NOT NULL, weapondmg INT NOT NULL, armordef INT NOT NULL, age INT UNSIGNED DEFAULT 0 NOT NULL, charm INT DEFAULT 0 NOT NULL, specialinc VARCHAR(50) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, specialmisc VARCHAR(1000) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, lastmotd DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, playerfights INT DEFAULT 3 NOT NULL, lasthit DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, seendragon TINYINT(1) DEFAULT \'0\' NOT NULL, dragonkills INT UNSIGNED DEFAULT 0 NOT NULL, restorepage VARCHAR(150) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, hashorse INT DEFAULT 0, bufflist LONGTEXT CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci` COMMENT \'(DC2Type:array)\', dragonpoints LONGTEXT CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci` COMMENT \'(DC2Type:array)\', boughtroomtoday TINYINT(1) DEFAULT \'0\' NOT NULL, sentnotice TINYINT(1) DEFAULT \'0\' NOT NULL, pvpflag DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, transferredtoday SMALLINT DEFAULT 0 NOT NULL, soulpoints INT UNSIGNED DEFAULT 0 NOT NULL, gravefights INT UNSIGNED DEFAULT 0 NOT NULL, hauntedby VARCHAR(50) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, deathpower INT UNSIGNED DEFAULT 0 NOT NULL, recentcomments DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, bio VARCHAR(255) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, race VARCHAR(50) CHARACTER SET utf8 DEFAULT \'0\' NOT NULL COLLATE `utf8_unicode_ci`, biotime DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, amountouttoday INT UNSIGNED DEFAULT 0 NOT NULL, pk TINYINT(1) DEFAULT \'0\' NOT NULL, dragonage INT UNSIGNED DEFAULT 0 NOT NULL, bestdragonage INT UNSIGNED DEFAULT 0 NOT NULL, ctitle VARCHAR(25) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, slaydragon TINYINT(1) DEFAULT \'0\' NOT NULL, fedmount TINYINT(1) DEFAULT \'0\' NOT NULL, clanid INT UNSIGNED DEFAULT 0, clanrank SMALLINT UNSIGNED DEFAULT 0 NOT NULL, clanjoindate DATETIME DEFAULT \'0000-00-00 00:00:00\' NOT NULL, chatloc VARCHAR(255) CHARACTER SET utf8 NOT NULL COLLATE `utf8_unicode_ci`, UNIQUE INDEX UNIQ_3A29410E9D02C3AF (acct_id), INDEX level (level), INDEX lasthit (lasthit), UNIQUE INDEX UNIQ_3A29410E6E6926DF (playername), INDEX name (name), INDEX alive (alive), INDEX clanid (clanid), PRIMARY KEY(id)) DEFAULT CHARACTER SET utf8 COLLATE `utf8_unicode_ci` ENGINE = InnoDB COMMENT = \'\' ');
        $this->addSql('ALTER TABLE accounts ADD CONSTRAINT FK_CAC89EAC1136BE75 FOREIGN KEY (character_id) REFERENCES characters (id) ON DELETE SET NULL');
        $this->addSql('ALTER TABLE characters ADD CONSTRAINT FK_3A29410E9D02C3AF FOREIGN KEY (acct_id) REFERENCES accounts (acctid) ON DELETE SET NULL');
        $this->addSql('DROP TABLE avatar');
        $this->addSql('DROP TABLE user');
        $this->addSql('DROP INDEX uri ON referers');
        $this->addSql('CREATE INDEX uri ON referers (uri(255))');
    }

    private function importData()
    {

        //-- Import characters to avatar
        $this->addSql('INSERT INTO avatar
        (`id`, `acct_id`, `name`, `playername`, `sex`, `strength`, `dexterity`, `intelligence`, `constitution`, `wisdom`, `specialty`, `experience`, `gold`, `weapon`, `armor`, `seenmaster`, `level`, `defense`, `attack`, `alive`, `goldinbank`, `marriedto`, `spirits`, `hitpoints`, `maxhitpoints`, `permahitpoints`, `gems`, `weaponvalue`, `armorvalue`, `location`, `turns`, `title`, `badguy`, `companions`, `allowednavs`, `resurrections`, `weapondmg`, `armordef`, `age`, `charm`, `specialinc`, `specialmisc`, `lastmotd`, `playerfights`, `lasthit`, `seendragon`, `dragonkills`, `restorepage`, `hashorse`, `bufflist`, `dragonpoints`, `boughtroomtoday`, `sentnotice`, `pvpflag`, `transferredtoday`, `soulpoints`, `gravefights`, `hauntedby`, `deathpower`, `recentcomments`, `bio`, `race`, `biotime`, `amountouttoday`, `pk`, `dragonage`, `bestdragonage`, `ctitle`, `slaydragon`, `fedmount`, `clanid`, `clanrank`, `clanjoindate`, `chatloc`)
        SELECT `id`, `acct_id`, `name`, `playername`, `sex`, `strength`, `dexterity`, `intelligence`, `constitution`, `wisdom`, `specialty`, `experience`, `gold`, `weapon`, `armor`, `seenmaster`, `level`, `defense`, `attack`, `alive`, `goldinbank`, `marriedto`, `spirits`, `hitpoints`, `maxhitpoints`, `permahitpoints`, `gems`, `weaponvalue`, `armorvalue`, `location`, `turns`, `title`, `badguy`, `companions`, `allowednavs`, `resurrections`, `weapondmg`, `armordef`, `age`, `charm`, `specialinc`, `specialmisc`, `lastmotd`, `playerfights`, `lasthit`, `seendragon`, `dragonkills`, `restorepage`, `hashorse`, `bufflist`, `dragonpoints`, `boughtroomtoday`, `sentnotice`, `pvpflag`, `transferredtoday`, `soulpoints`, `gravefights`, `hauntedby`, `deathpower`, `recentcomments`, `bio`, `race`, `biotime`, `amountouttoday`, `pk`, `dragonage`, `bestdragonage`, `ctitle`, `slaydragon`, `fedmount`, `clanid`, `clanrank`, `clanjoindate`, `chatloc` FROM `characters`');

        //-- Import accounts to user
        $this->addSql("INSERT INTO  user (`acctid`, `avatar_id`, `laston`, `loggedin`, `superuser`, `login`, `lastmotd`, `locked`, `lastip`, `uniqueid`, `boughtroomtoday`, `emailaddress`, `replaceemail`, `emailvalidation`, `sentnotice`, `prefs`, `transferredtoday`, `recentcomments`, `amountouttoday`, `regdate`, `banoverride`, `donation`, `donationspent`, `donationconfig`, `referer`, `refererawarded`, `password`, `forgottenpassword`, `roles`)
        SELECT `acctid`, `character_id`, `laston`, `loggedin`, `superuser`, `login`, `lastmotd`, `locked`, `lastip`, `uniqueid`, `boughtroomtoday`, `emailaddress`, `replaceemail`, `emailvalidation`, `sentnotice`, `prefs`, `transferredtoday`, `recentcomments`, `amountouttoday`, `regdate`, `banoverride`, `donation`, `donationspent`, `donationconfig`, `referer`, `refererawarded`, `password`, `forgottenpassword`, '[]' FROM accounts");
    }
}
